name: "Commit Version Changes"
description: "Commit and push version changes to branch"
inputs:
  version:
    description: "Version being updated"
    required: true
  temp-branch:
    description: "Temporary branch to push to"
    required: true
  dry-run:
    description: "Dry run mode - show what would be committed without pushing"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Commit and push changes
      shell: bash
      env:
        VERSION: ${{ inputs.version }}
        TEMP_BRANCH: ${{ inputs.temp-branch }}
        DRY_RUN: ${{ inputs.dry-run }}
      run: |
        COMMIT_MSG="chore: bump version to $VERSION

        - Update VALKEY_GLIDE_PHP_VERSION in common.h
        - Update release and API versions in package.xml
        - Update date and time in package.xml

        Signed-off-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

        # Add files to staging
        git add common.h package.xml

        # Check if there are changes to commit
        if git diff --cached --quiet; then
          echo "No changes to commit"
          exit 0
        fi

        # Show what files will be committed
        echo "Files to be committed:"
        git diff --cached --name-only

        if [ "$DRY_RUN" = "true" ]; then
          echo "DRY RUN: Committing locally but not pushing"
          echo "Branch: $TEMP_BRANCH"
          echo "Commit message:"
          echo "$COMMIT_MSG"
          
          # Commit locally but don't push
          git commit -m "$COMMIT_MSG"
          echo "Local commit created successfully (not pushed in dry-run mode)"
        else
          echo "Committing and pushing version changes"
          echo "Branch: $TEMP_BRANCH"
          
          git commit -m "$COMMIT_MSG"
          git push origin "$TEMP_BRANCH"
          echo "Changes committed and pushed successfully"
        fi
