name: Build and publish extension packages

permissions:
  contents: write

on:
  release:
    types: [published]
  pull_request:
    paths:
      - "common.h"
      - "package.xml"
      - ".github/workflows/publish-pecl.yml"
      - ".github/workflows/update-version-files/**"
      - ".github/workflows/setup-release-branches/**"
      - ".github/workflows/commit-version-changes/**"
      - ".github/workflows/create-version-pr/**"
      - ".github/workflows/validate-version/**"
      - ".github/workflows/test-pecl-package/**"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (e.g., 0.9.0)"
        required: true
        type: string
      release-branch:
        description: "Release branch name (e.g., release-0.10)"
        required: true
        type: string
      create-release:
        description: "Create GitHub release"
        type: boolean
        default: false
      dry-run:
        description: "Dry run mode (test workflow without creating branches/PRs/tags)"
        type: boolean
        default: false

jobs:
  prepare-version-bump:
    name: Prepare Version Bump${{ (github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry-run == 'true')) && ' (DRY RUN)' || '' }}
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'
    outputs:
      branch-name: ${{ steps.setup-branch.outputs.branch-name }}
      pr-number: ${{ steps.create-pr.outputs.pull-request-number }}
      dry-run: ${{ github.event_name == 'pull_request' || github.event.inputs.dry-run }}
      version: ${{ steps.determine-version.outputs.version }}
      release-branch: ${{ steps.determine-version.outputs.release-branch }}
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine version and release branch
        id: determine-version
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
          INPUT_RELEASE_BRANCH: ${{ github.event.inputs.release-branch }}
        run: |
          if [ "$EVENT_NAME" = "pull_request" ]; then
            # For PR events, extract current version and create test values
            CURRENT_VERSION=$(grep -o '#define VALKEY_GLIDE_PHP_VERSION "[^"]*"' common.h | sed 's/#define VALKEY_GLIDE_PHP_VERSION "\([^"]*\)"/\1/')
            echo "Current version from common.h: $CURRENT_VERSION"
            
            # Create PECL-compatible test version by appending RC
            TEST_VERSION="${CURRENT_VERSION}RC"
            TEST_RELEASE_BRANCH="release-$(echo $CURRENT_VERSION | cut -d. -f1-2)"
            
            echo "version=$TEST_VERSION" >> $GITHUB_OUTPUT
            echo "release-branch=$TEST_RELEASE_BRANCH" >> $GITHUB_OUTPUT
            
            echo "ðŸ§ª PR Mode: Using PECL-compatible test version $TEST_VERSION (release candidate format) and release branch $TEST_RELEASE_BRANCH"
          else
            # For workflow_dispatch, use provided inputs
            echo "version=$INPUT_VERSION" >> $GITHUB_OUTPUT
            echo "release-branch=$INPUT_RELEASE_BRANCH" >> $GITHUB_OUTPUT
            
            echo "Manual Mode: Using version $INPUT_VERSION and release branch $INPUT_RELEASE_BRANCH"
          fi

      - name: Validate version format
        env:
          VERSION: ${{ steps.determine-version.outputs.version }}
          EVENT_NAME: ${{ github.event_name }}
        run: |
          echo "Validating version format: $VERSION"

          if [ "$EVENT_NAME" = "pull_request" ]; then
            echo "PR Mode: Skipping strict version format validation for test version"
            echo "Test version: $VERSION"
          else
            if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$ ]]; then
              echo "ERROR: Invalid version format: $VERSION"
              echo "Expected format: X.Y.Z or X.Y.Z-rcN (e.g., 1.0.0, 1.0.0-rc1)"
              exit 1
            fi
            
            echo "Version format is valid: $VERSION"
          fi

      - name: Setup branches
        id: setup-branch
        uses: ./.github/workflows/setup-release-branches
        with:
          release-branch: ${{ steps.determine-version.outputs.release-branch }}
          dry-run: ${{ github.event_name == 'pull_request' || github.event.inputs.dry-run }}

      - name: Update version files
        uses: ./.github/workflows/update-version-files
        with:
          version: ${{ steps.determine-version.outputs.version }}
          dry-run: ${{ github.event_name == 'pull_request' || github.event.inputs.dry-run }}

      - name: Validate version consistency
        if: github.event_name != 'pull_request'
        uses: ./.github/workflows/validate-version
        with:
          expected-version: ${{ steps.determine-version.outputs.version }}
          source: manual

      - name: Commit and push changes
        uses: ./.github/workflows/commit-version-changes
        with:
          version: ${{ steps.determine-version.outputs.version }}
          temp-branch: ${{ steps.setup-branch.outputs.temp-branch }}
          dry-run: ${{ github.event_name == 'pull_request' || github.event.inputs.dry-run }}

      - name: Create Pull Request
        id: create-pr
        uses: ./.github/workflows/create-version-pr
        with:
          version: ${{ steps.determine-version.outputs.version }}
          temp-branch: ${{ steps.setup-branch.outputs.temp-branch }}
          target-branch: ${{ steps.setup-branch.outputs.target-branch }}
          dry-run: ${{ github.event_name == 'pull_request' || github.event.inputs.dry-run }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

  wait-for-merge-and-tag:
    name: Create Release Tag
    runs-on: ubuntu-latest
    needs: prepare-version-bump
    if: github.event_name == 'workflow_dispatch' && needs.prepare-version-bump.outputs.dry-run != 'true'
    environment: release-approval # This requires manual approval
    steps:
      - name: Check if PR is merged
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.prepare-version-bump.outputs.pr-number }};

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            if (!pr.merged) {
              throw new Error(`PR #${prNumber} must be merged before creating the tag. Current state: ${pr.state}`);
            }

            console.log(`PR #${prNumber} has been merged to ${pr.base.ref}! Proceeding with tag creation.`);

      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-version-bump.outputs.release-branch }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        run: |
          VERSION="${{ needs.prepare-version-bump.outputs.version }}"
          TAG_NAME="v$VERSION"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "$TAG_NAME" -m "Release $TAG_NAME

          This tag was created after PR #${{ needs.prepare-version-bump.outputs.pr-number }} was merged.

          Version: $VERSION
          Release Date: $(date -u +%Y-%m-%d)

          Signed-off-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git push origin "$TAG_NAME"

          echo "Tag $TAG_NAME created and pushed successfully!"

  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    outputs:
      is-rc: ${{ steps.check-rc.outputs.is-rc }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if version is a release candidate
        id: check-rc
        run: |
          if [[ "${{ github.event.release.tag_name }}" =~ -rc[0-9]+ ]]; then
            echo "is-rc=true" >> $GITHUB_OUTPUT
            echo "Release candidate detected - PECL package will be skipped"
          else
            echo "is-rc=false" >> $GITHUB_OUTPUT
            echo "Stable release detected - PECL package will be built"
          fi

      - name: Validate version consistency
        uses: ./.github/workflows/validate-version
        with:
          expected-version: ${{ github.event.release.tag_name }}
          source: "release"

  build-packages:
    runs-on: ubuntu-latest
    needs: [validate-version, wait-for-merge-and-tag, prepare-version-bump]
    if: |
      always() &&
      (needs.validate-version.result == 'success' || needs.validate-version.result == 'skipped') &&
      (needs.wait-for-merge-and-tag.result == 'success' || needs.wait-for-merge-and-tag.result == 'skipped' || github.event_name == 'pull_request') &&
      (needs.validate-version.outputs.is-rc != 'true')
    outputs:
      package-version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && needs.prepare-version-bump.outputs.release-branch || github.ref }}
          submodules: recursive

      - name: Install Rust and protoc
        uses: ./.github/workflows/install-rust-and-protoc
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Rust to PATH
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source $HOME/.cargo/env || true

      - name: Determine version
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
          PREPARE_VERSION: ${{ needs.prepare-version-bump.outputs.version }}
        run: |
          if [ "$EVENT_NAME" = "release" ]; then
            VERSION="$RELEASE_TAG"
            # Remove 'v' prefix if present
            VERSION=${VERSION#v}
          elif [ -n "$PREPARE_VERSION" ]; then
            # Use version from prepare-version-bump job (for PR and workflow_dispatch)
            VERSION="$PREPARE_VERSION"
          else
            # Fallback to input version
            VERSION="$INPUT_VERSION"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Publishing version: $VERSION"

      - name: Generate submodule commit info
        run: |
          # Generate submodule commit info for PECL packages
          echo "=== Generating submodule commit info ==="
          git submodule status | while read commit path extra; do
            # Remove leading - or + from commit hash
            clean_commit=$(echo "$commit" | sed 's/^[-+]//')
            echo "$path=$clean_commit" >> .submodule-commits
          done
          cat .submodule-commits

          echo "=== Version files are already updated from previous steps ==="
          VERSION="${{ steps.version.outputs.version }}"
          COMMON_VERSION=$(grep -o '#define VALKEY_GLIDE_PHP_VERSION "[^"]*"' common.h | sed 's/#define VALKEY_GLIDE_PHP_VERSION "\([^"]*\)"/\1/')
          RELEASE_VERSION=$(grep -o '<release>[^<]*</release>' package.xml | head -1 | sed 's/<[^>]*>//g')

          echo "Current common.h version: $COMMON_VERSION"
          echo "Current package.xml version: $RELEASE_VERSION"
          echo "Expected version: $VERSION"

      - name: Create PECL package
        id: build-package
        uses: ./.github/workflows/build-pecl-package
        with:
          version: ${{ steps.version.outputs.version }}

      - name: Test package installation
        uses: ./.github/workflows/test-pecl-package
        with:
          php-version: "8.2" # Use a stable PHP version for testing
          engine-version: "7.2.5"
          package-path: ${{ steps.build-package.outputs.package-file }}
          skip-package-creation: "true"

      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: valkey-glide-php-${{ steps.build-package.outputs.package-version }}
          path: |
            ${{ steps.build-package.outputs.package-file }}
          retention-days: 90

      - name: Create GitHub release
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.create-release == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        uses: actions/create-release@v1
        with:
          tag_name: v${{ steps.build-package.outputs.package-version }}
          release_name: Valkey GLIDE PHP v${{ steps.build-package.outputs.package-version }}
          body: |
            ## Valkey GLIDE PHP Extension v${{ steps.build-package.outputs.package-version }}

            High-performance PHP client for Valkey and Redis with Rust-based core.

            ### Installation

            **PIE (Recommended):**
            ```bash
            pie install valkey-io/valkey-glide-php
            ```

            **PECL-style:**
            ```bash
            pecl install https://github.com/valkey-io/valkey-glide-php/releases/download/v${{ steps.build-package.outputs.package-version }}/${{ steps.build-package.outputs.package-file }}
            ```

            **Manual:**
            Download the tarball below and follow the installation instructions.

            ### Requirements
            - PHP 8.1+
            - Git, Rust toolchain, build tools

            See README.md for detailed installation instructions.
          draft: false
          prerelease: false

      - name: Upload release assets
        if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && github.event.inputs.create-release == 'true')
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url || steps.create-release.outputs.upload_url }}
          asset_path: ${{ steps.build-package.outputs.package-file }}
          asset_name: ${{ steps.build-package.outputs.package-file }}
          asset_content_type: application/gzip
